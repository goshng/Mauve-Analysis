Mauve, Clonal Frame, Clonal Origin Analysis
===========================================

History
-------
Jobs that were done are described for later reference.

.Meaning of arrows
-> means I finished the job.
---> means I need to do something about it.

Fri Apr 29 13:54:44 EDT 2011
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

s13's analysis is being analyzed. This is the same analysis as s11 except the
block configuration. I have two purposes: one for checking as s11, and another
for comparing the simulation result with the real data. The simulation results
can be similar to the prior count. I wish to extract any effect of clonal
origin's inference using simulation.
--->

Thu Apr 28 14:14:00 EDT 2011
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

I am trying to draft a manuscript.
--->


Wed Apr 27 10:34:40 EDT 2011
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The result of s10 shows that higher number of events tend to be underestimated.
Recombination events of 0 tend to be overestimated.

s11's analysis is being analyzed. Counting recombination events is slow: s11 is
1 repetition, 10 replicates with 100 blocks. Each replicate has 101 iterations.
-> done in 2 days (5 nodes) -> see the result
output/s11/run-analysis/1.R.out

s12 is executed in CAC.
-> done in 2 days (5 nodes) ---> ?

output/cornellf/8/run-clonalorigin/output2/2 is executed. 
Burnin/ChainLength/Thin are 10,000,000/100,000,000/100,000. 
A previous run is saved as
cornellf/8/run-clonalorigin/output2/2a. The previous run of 2a was executed with
Burnin/ChainLength/Thin were 1,000,000/10,000,000/100,000. It took less than a
day.
-> done in 2 days (3 nodes) -> three analyses --->

cornellf/3/run-clonalorigin/output2/1 is executed.
Burnin/ChainLength/Thin are 10,000,000/100,000,000/100,000.
A previous run is saved as
cornellf/3/run-clonalorigin/output2/1a. The previous run of 1a was executed with
Burnin/ChainLength/Thin were 1,000,000/10,000,000/100,000. It took less than a
day.
-> still running in 2 days (3 nodes)
... the last 100 jobs were submitted cornellf/3/run-clonalorigin2 (5 nodes)
... check tomorrow --->

The main analyses should be recoded: counting recombination events, measure of
recombination intensity (or probability of experiencing recombination events),
and gene ontology analysis with recombination intensity measure for genes.
Matt suggested that probability that a gene experiences recombination is the
proportion of total iterations where the gene is affected by any recombinant
edge. I am trying to code this one.

I am starting to write a manual for this mauve-analysis.


s10
---
I wish to check if clonal origin can recover the number of recombination events.
A single repetition with a single block is performed. 100 replicates are used.

s11
---
I wish to check if clonal origin can recover the number of recombination events.
A single repetition with multiple blocks is performed. 10 replicates are used
because the number of blocks can be large. The number of blocks is 100.


Current analysis
----------------
s9 is done
cornellf/2/run-clonalorigin/output/1 not done yet.


repetition 8 - replicate 2 
s7

cornellf's repetition 8 (5000 minimum) is considered. 

I am running this repetition 8 on the cluster. 
I want to know what is the difference from the 411 cluster and 71 cluster.
Median theta: 0.0749323036174269
Median delta: 614.149554455445
Median rho: 0.0137842770601471

Interestingly I have the following values from 415-block analysis. It seems that
the chain length of the previous one was too short. I may have to try the limit
of 1000. This is Repetition 2.
Median theta:0.0805492163856909
Median delta:795.814391608391
Median rho:0.0104334916432993

cornellf/2/run-clonalorigin/output/1
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ClonalFrameREPLICATE:1
REPLICATE:1
ClonalFrame Tree:1
-x 1,000,000 -y 10,000,000 -z 100,000
Not done yet.

cornellf/3/run-clonalorigin/output/1
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
1) bacillus    4) s1         7) s4        10) s7        13) test
2) cornell5    5) s2         8) s5        11) s8
3) cornellf    6) s3         9) s6        12) s9
Choose the species to analyze with clonalorigin: 3
What repetition do you wish to run? (e.g., 1) 3
Which replicate set of ClonalFrame output files?
ClonalFrame REPLICATE ID: 1
Which replicate set of ClonalOrigin output files?
ClonalOrigin REPLICATE ID: 1
Which clonal frame is used for a phylogeny? (e.g., 1) 1
-x 1,000,000 -y 10,000,000 -z 100,000


Directories
-----------

simulation
~~~~~~~~~~
Simulation setups are stored in this directory.

species
~~~~~~~
This directory contains text files, each of which describes a data set and
the purpose of analysis of thereof. 

output
~~~~~~
This directory contains subdirectories with the same names as those in the main
directory called +species+. A subdirectory contains more directories with
positive integer numbers.

Bacteria species under study
----------------------------

bacillus
~~~~~~~~
A smaller data set seems to work with ClonalFrame.
I stopped at ClonalFrame's analysis with a smaller dataset.
I think that the running option that I use ClonalFrame seems okay.

Staphylococcus aureus
~~~~~~~~~~~~~~~~~~~~~
This should be analyzed similarly to that of B. cereus because recombination
rates seem comparable to those of B. cereus. The number of species is also
comparable.

Staphylococcus
~~~~~~~~~~~~~~
I want to test the hypothesis that is depicted by Figure 16.4 of the bacterial
population genetics book. See the page at 335 of the book.
Evolutionary scenario of S. epidermidis and S. aureus.
S. epidermidis has higher recombation rates than S. aureus. 
Did their most recent common ancestor have high recombination rates as S.
epidermidis?  Or, did it have low recombination rates as S. aureus?
There are 6 more genomes that are in Staphylococcus genus. These genomes should
inform us of the state of the ancestor of S. epidermidis and S. aureus.
I want to find one outgroup first.

Sulfolobus_islandicus
---------------------
There are 7 genomes.
Mauve alignment: PASS!
ClonalFrame (small): PASS!
ClonalOrigin: in progress...
This may be the first example that I can analyze with ClonalFrame and
ClonalOrigin.  

Sulfolobus
----------
Four more members of Sulfolobales are added.
There are 11 genome members of Sulfolobales.
Horizontal gene transfer can be studied using Clonal Origin.
Their timing can be summarized.
This data set of 11 genomes may not have a single species tree.

Sulfolobus8
-----------
We remove three genomes leaving 8 genomes.
We might study when genomic segments migrated between the 8-th genomes and each
of the 7 S. islandicus genomes.
I am interested in gene flow between the outgroup and the 7 ingroup genomes.
I ran 2 sets of jobs, and each with 3 independent runs of 5,000 and 10,000 (?):.
Two out of three are similar and one of them has longer branch lengths.
MC3 may be necessary.  We might try more chains not 3.

cornell6
--------
In addition to the 5 genomes from cornell, S. canis is also added.
3 blocks are removed because their alignments do have too much deletions. Some
alignments have large partial one side flanking gaps.
1:17740
1:160477
4:1720750

cornellf
--------
Somehow I got wrong version of SDE1 and SDD genomes. I asked Haruo for the
version that he had. This cornellf means the final version of cornell5. The
older version and the new one of SDE1 seem to be almost the same. SDD's genomes
are somewhat different, but not much.

Repetition 1: The 411 blocks that are filtered using 500 base pairs minimum.

Repetition 2
~~~~~~~~~~~~
I use 1000 base pairs minimum for the filtering.

The filtering of 1000 minimum length yields 341 blocks.  I removed 3 blocks with
large gaps, which yields 338.

Repetition 3
~~~~~~~~~~~~
I use 1500 base pairs minimum for the filtering. I removed 2 blocks with large
gaps (blocks with consecutive gaps of size larger than 50).

Repetition 4
~~~~~~~~~~~~
I use 2000 base pairs minimum for the filtering. I removed 2 blocks with large
gaps (blocks with consecutive gaps of size larger than 50).

Repetition 5
~~~~~~~~~~~~
I use 2500 base pairs minimum for the filtering. I removed 1 block with large
gaps (blocks with consecutive gaps of size larger than 50).

Repetition 6
~~~~~~~~~~~~
I use 3000 base pairs minimum for the filtering. I removed 1 block with large
gaps (blocks with consecutive gaps of size larger than 50).

Repetition 7
~~~~~~~~~~~~
I use 4000 base pairs minimum for the filtering. I removed 1 block with large
gaps (blocks with consecutive gaps of size larger than 50).

Repetition 8
~~~~~~~~~~~~
I use 5000 base pairs minimum for the filtering. I removed no block with large
gaps (blocks with consecutive gaps of size larger than 50).

simulation
----------

s1: 1 block of 10,000 base pairs (100 times) -> Okay!
s2: Real data - 500 minimum block
s3: 10 blocks of 10000 base pairs (5 times) -> Not okay
s4: Real data - 4000 base pairs of minimum block (2 times)
s5: 10 blocks of 10000 base pairs (50 times) -> Seems okay! s3's result is due
to smaller repetitions.
s6: 100 blocks of 10000 base pairs (5 times) -> Seems okay, too!
s8: 1 block - 10k base pairs (100 times)
s9: 100 blocks - 10k base pairs (5 times)
s10: 1 block with the same recombinant edges - 10k base pairs (100 times)

cornell5
--------
SEE is removed from the analysis of cornell6 because a whole genome may be
enough to root the tree, and the outgroup of SEE may not be necessary.
Two of three ClonalFrame runs seems concordant.  I proceed with the first stage
of ClonalOrigin analysis. 
Several blocks need more computing time than many others.

ClonalFrame's analyses 1 and 2 are similar.  Replicate 1 uses the 2nd one, and
replicate 2 uses the 1st one.  The 0-th ClonalFrame analysis is not similar to
those, and it is not used.

Among 419 blocks 3 blocks are removed and the data set consists of 416 blocks.
The removed blocks have weird gaps: 67,82,153,293 are moved. 
67 and 82 do not have gaps but its takes too much time to run them with 
clonal origin probably due to very large number of recedges.

In the second runs of clonalframe, I have multiple trees. The tree (A) that I used
before apprears in 3 out of 7. One tree with higher likelihood appears, and this
is problematic. Since I have to assess the convergence issue of 1st
ClonalOrigin and the tree A appears to make sense, I use one of the tree say,
ClonalFrame RUNID of 1 to proceed to ClonalOrigin analysis.

RUNID=5 Note that this is the run id of ClonalFrame runs.

CLONALFRAMEREPLICATE=2 Note that this replicate is one for run-clonalframe not
run-clonalorigin.

REPLICATE=1 This is the replicate number for run-clonalorigin.

67,82,153,293 are removed from 419.
121,160,203,247 will be removed from 415 because 160's log-likelihood does not
seem to converge. 121,203,247 takes too much time to finish.
What are those that are removed from 419?
Multiple 2's, 160's and 236's are running run-clonalorigin5 at 6.

67  82       153                 293 among 419.
        121       160  203  247      among 415.
67  82  123  153  163  206  250  293 among 419 ?
67,82,123,153,163,206,250,293
were filtered out.

0.0542/1425/0.00521 are used for 2nd clonal origin analysis.

run-analysis
~~~~~~~~~~~~
NC_004070.gff

I downloaded bcp_go_role_link and bcp_role_link at
ftp://ftp.jcvi.org//pub/data/Omniome_Database/tab_delimited_omniome

I downloaded loci information of MGAS315 at
http://cmr.jcvi.org
as files
bcp_m3_jcvi_locus.txt
and 
bcp_m3_primary_locus.txt.

I compare bcp_m3_jcvi_locus.txt with bcp_m3_primary_locus.txt to find one-to-one
associations between primary locus (Genbank locus_tag) and JCVI locus. I use
bcp_go_role_link to find gene ontology annotations for the JCVI loci. The
one-to-one associations are used to assign primary loci with their gene ontology
annotations. What is bcp_role_link?

I can list roles at
http://cmr.jcvi.org/cgi-bin/CMR/shared/RoleList.cgi

Where are links between role id and these role categories?
I found a web site at
http://cmr.jcvi.org/cgi-bin/CMR/shared/RoleList.cgi
and saved it as a source file named jcvi_role.html.
I parse jcvi_role.html to find the assignment role IDs of JCVI role category
lists.

For JCVI roles I can group locus tags by main roles or submain roles using the
numbers.  For gene ontologies I should be able to test if a gene ontology
category of a locus tag belongs to a main gene ontology category; say metabolism
within a cellular process.  There is a slim gene ontology as far as I know. The
slim gene ontology should contain most gene ontology categories and it can be
used to test a gene ontology category's membership in the gene ontology. There
must be a PERL script to test that. Let me find the PERL script and the slim
gene ontology file. Note that one locus tag can belong to multiple functional
categories.


spyogenes
---------
I used 13 genomes. Two runs did not converge. Clonal frame is hard to obtain.
One of two runs seems stucked at a tree, and mixing was bad.
One of the runs runs okay. This is encouraging (Note the spyogenes6 did not
work, or R value increases to reach a plateau. 

An EPS formatted figure is generated by FigTree.
$ convert figure1.eps figure2.eps
to add it to the asciidoc text file.


spyogenes6
-----------
Each of three pairs of genomes are from the same M type. I remove one of each
pair. I also remove some to make a set of 6 species. The idea is if MCMC chains
converge and mix with a smaller number of species.
I see a similar problem: R value increases to reach a plateau.
I turn to cornell5 data set.

Burkholderia_cenocepacia
------------------------
This archea species include 4 genomes. Interestingly each genome consists of
multiple circular chromosomes or 3 chromosome. I combine the multiple
chromosomes to a single one. This can serve as a genome for ClonalFrame
analysis.
The analysis of archea may be interesting.

The genomes 1 and 2 are almost the same.
[literal]
cat ~/Elements/Documents/Projects/mauve/bacteria/Burkholderia_cenocepacia_MC0_3_uid58769/*.gbk > 1.gbk
union -sequence 1.gbk -sformat genbank -outseq 2.gbk -osformat genbank -feature Y -auto
mv 2.gbk Burkholderia_cenocepacia_MC0_3.gbk
rm 1.gbk

The clonalframe analysis did not work with walltime of 268 hours.
I should work on it with larger walltime.


Salmonella_enterica
-------------------
I do not know what brought me to analyze this.
smaller clonal frame was finished.
The 16 genome data set clonalframe analysis failed to converge. I remove 4 of
them to have 12 genomes.  I stop this analysis until I know what I should do.
Obviously, I have to restart from 12 genome alignment using mauve.

cornell6
--------

union -sequence SCAZ3_08042009.gbf -sformat genbank -outseq sca.gbk -osformat genbank -feature Y -auto

Command Lines
-------------

To find genomes of a species
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[literal]
cd /Users/goshng/Elements/Documents/Projects/mauve/bacteria
[literal]
ls -l `find . -name *.gbk`| grep Staphylococcus_aureus > ~/Documents/Projects/mauve/species/Staphylococcus_aureus

To create a genome analysis
~~~~~~~~~~~~~~~~~~~~~~~~~~~
[literal]
bash sh/run.sh leptospira



Directories
-----------

cac
~~~
Examples of batch scripts for submitting jobs to CAC cluster.

streptococcus
~~~~~~~~~~~~~
Fourteen genomes are collated for a mauve analysis.

Problems
--------
ClonalFrame seems slow with increase in number of blocks.
Bacillus data set is hard to analyze with ClonalFrame. 
Streptococcus data set is smaller than Bacillus data set in size. 

streptococcus
~~~~~~~~~~~~~
N=14, b=471, L=603426
means that 14 genomes share 471 blocks that combine to be 603,426 in characters.
It would take about a week to run 20,000 generations of MCMC.

bacillus
~~~~~~~~
N=13, b=1200, L=3596990
means that 13 genomes share 1,200 blocks that combine to be 3,596,990 in
characters. This would take 8 days (or more than a week) to run 8,000
generations of MCMC.

External Programs
-----------------
Some perl scripts and c++ source files are prepared for helping mauve analyses.
- blocksplit2fasta.pl: A perl script that splits a core alignment to multiple
  fasta files. These fasta files are taken as input to
  compute_watterson_estimate to compute Watterson's estimate.
- blocksplit2smallerfasta.pl: A perl script that subsample blocks from a core
  alignment. 
- compute_watterson_estimate: A c++ source file that computes Watterson's
  estimates of DNA sequence alignments.
[literal]
/Users/goshng/Documents/Projects/biopp/bpp-test/compute_watterson_estimate.cpp
- Convert core to smaller core.
[literal]
usr/bin/core2smallercore.pl

- To find per-site mutation rate, recombination rate, and track length (1st
  ClonalOrigin):
[literal]
usr/bin/extractClonalOriginParameter.pl

- To summarize recedges (2nd ClonalOrigin):
[literal]
usr/bin/extractClonalOriginParameter2.pl

- To generate trace plot of mutation rate, recombination rate, and track length
  (1st ClonalOrigin):
[literal]
usr/bin/extractClonalOriginParameter3.pl

Useful Bash Script
------------------
- To cancel multiple CAC jobs:
[literal]
for i in {1..15}; do mjobctl -c 1074682-$i; done
[literal]
for i in {1..419}; do tail -v -n 1 output/core_co.phase2.$i.xml >> 1; done

- To list iteration numbers for all the jobs:
[literal]
for i in {1..120}; do grep --with-filename number core_co.phase3.$i.xml | tail -n 1; done | less

Two jobs were not finished in the 1st stage of ClonalOrigin
-----------------------------------------------------------
core_co.phase2.293.xml
core_co.phase2.67.xml

Summarization of ClonalOrigin
-----------------------------
Recedge by recedge I count the import source.  Then divide those values by the
number of sample sizes.

How to plot a EPS figure?

Checks
------
. Count remaining jobs when the total length of a chain is 2000000:
[literal]
grep "<number>2000001" output/2/* | wc
[literal]
for i in {1..419}; do grep --with-filename "<number>" output/2/core_co.phase2.$i.xml | tail -n 1; done | grep -v 2000001 | wc

To Do
-----
Change the following code to generate some figures for recombinant edges given a
clonal frame and a genome. We need a reference genome. I think that the first
SDE1 can be a reference genome.
The length of a block can be found XML tag <Blocks>. The start and end positions
of a block along the genome SDE1 can be found the block of alignment: e.g.,
core_alignment.xmfa.55.  The first sequence has the start and end position.
Note that the block length should be equal to the sum of abs(start - end) + 1 +
number of gaps in the alignment. The start and end positions are inclusive.
[literal]
usr/bin/extractClonalOriginParameter2.pl

Check REPLICATE bash variable in run.sh.

I should compare 2 replicates of the first stages of clonal origin MCMC.

gff
---
The following lines should be in the gff file. Then IGB can display names.

##gff-version 3
#!gff-spec-version 1.14
#!source-version NCBI C++ formatter 0.2
##Type DNA NC_0004070.1

Long Jobs
---------
cornell5
^^^^^^^^
67 and 293


CMake
-----
cmake -DCMAKE_CXX_FLAGS="-g3 -ggdb -O0" b
cd b
make

GDB with C++
------------
.To check the content of a vector
print *(blocks._M_impl._M_start)@blocks.size()

.To iterate the content of a vector
for (unsigned i = 0; i < blocks.size(); i++) {
  cout << "[" << i << "] " << blocks[i];
}

The latest commands
-------------------
for i in {1..18}; do mjobctl -c 1081180-$i; done

About simulation
----------------
I simulate the clonal origin model to generate sequence data. By product I would
have a clonal frame with recombinant edges. I can use multiply repeated
sequence data to recover mutation rate, recombination rate, recombinant tract
length. I cannot recover recombinant edges because the recombinant edges are one
realization of the model. This is like attempting to recover a data set, which
is also one realization. I need to generate multiple data from a clonal
frame with a single set of recombinant edges. This requires changing weakargsim
code.

Given a species tree, and the true values of the 3 main parameters.
1. The number of recombinant edges.
2. Heat map analysis.
3. Recombination intensity.


